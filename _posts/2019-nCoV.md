---
layout: post
title:  "How to model the progression of the Chinese coronavirus"
date: '2019-12-25 21:30:00'
---

## Introduction
December the 31st the Chinese health autorities informed about a case of pneumonia of unknown origin. Three days after, another 43 cases were reported to the WHO. Twelve days later the Chinese goverment had found the pneumonias were caused by a new type of coronavirus (link) and traced back the origin of the disease to a with a seafood market in [Wuhan]().
One month later 170 persons have died and there are 7818 confirmed cases plus 12167 suspected cases among 18 countries.
Today in this post I am going to explain how to use numerical simulations to study and predict outbreaks like this one.
{: style="text-align: justify"}

## The infection.
So far the amount of known information about the virus is very limited but there are some facts that seem to be clear.

1st. The causal agent is a coronavirus: Coronaviruses are viruses that are transmited from animals to humans. For this jump between species to happen, the viruses must gain the ability to infect new species through mutations in their genetic material. 
2nd. During these 30 days the virus has propagated following and exponential progression:

[!progression]()

Looking at the data, it seems that it would be possible to fit it with a function like:

$$\[y=1+a·e^{b·x}\]$$

To do that we first need to make a guess for the staring values of a and b. Something that we can du applying logs to the equation in order to transform it into a linear equation:

log(y-1)=log(a)+bx

In this way we can estimate log(a) and b:

linear<-lm(log(df$Infected-1)~df$Day)
start <- list(a=exp(coef(linear)[1]), b=coef(linear)[2])

Now that we have the coeficients for the linear fit we can used them as starting point to estimate the coeficients of the exponential fit:

mod <- nls(Infected ~ a*(exp(b*Day)), data = df, start = start)

We extracts the coeficients and to make predictions:

a-The model predicts that tomorrow 31st of January there will be 11437 infected. 
b-According to the model every 24 hours the number of infections multiplies by 1.41

## Numerical simulations vs multivariate functions

So far we have created a very basic model which takes into account just one parameter (time) modeling infections requires introducing a lot a lot of parameters into the equations (e.g. natural immunity, population density, number of deaths, etc); however, creating such multivate functions can be so complex that in most of the case it not even possible from a practical point of view. On the other hand, numerical simulations are extremely poweful, we can add new constrains with a couple of lines code. They are so powerful that we could even simulate a virus spreading to a new country based on the traveling rates or what would happen if a vaccine is found and we start vaccinating the population at a certain rate. As a counterpart, the simulations can be slow if we add too many constrains or when simulating big populations. 

To do this in R we first create a vector which will represent the population that we want to model. 

#Parameters
Total_pop<-10000
df<-rep(1, Total_pop)

The elements of the vector represent the member of the population and the values the status of the subjets. In our case we assing 1 to non-infected but susceptible members, 0 are dead subjects, 2 are immune members and values > 3 represent infected members. As you can imagine you can expand this as much as you like just by adding new rules that you can check during the progression of the disease. 

Now that we have our population, we can infect the patient-zero[link]()

patient_zero<-sample(which(df==1),1)
df[patient_zero]<-3

And we can start tracking the progression of the dissease with a for loop. In this case I define each iteration as a single day but you can change that to study quicker or slower processes (e.g. 1 iteration/second, 1 iteration/year). 

for(i in 1:time){
  df[df>=3]<-df[df>=3]+1
  
As you can see, the first thing that we do during each iteration (day) is to change the status of the infected by adding 1 to them.
Next we find out how many people gets infected. We compute that using two factors: the number of people in contact with each other and the probability of getting infected if you are contacted by an infected one:

for (k in 1:length(which(df>=3))) {
    round_contacts<-sample(which(df!=0),contact_rate)
    new_infected<-vector()
    for (l in 1:length(round_contacts)) {
      if(runif(1, min = 0, max = 1)<=Infection_rate) new_infected<-c(new_infected,round_contacts[l] )
      
    }
    new_infected<-length(new_infected)
    if(new_infected>0){
      
      if(length(which(df==1))<new_infected){
        new_infected<-length(which(df==1))
      }
    
    new_infected<-sample(which(df==1),new_infected)
    df[new_infected]<-3}
  }
  
The advantage of using these parameters is that it is possible to account for quarentines or more sparse areas/countries at the same time that we account for the ability of an infective agent to propagate. In the multivariate functions those parameters are combined in the R0 parameter[](); however as you can see we don't need it. 

Next, we compute the number of deceased:

  #Deaths
  infected<-which(df>=3)
  for (j in 1:length(infected)) {
    if(runif(1, min=0, max = 1)< ((1-Survival_rate)/silent_infection)) df[infected[j]]<-0
  }  
  
Then, we asume that patients after reaching certain day get cured and that they become immune, in my model this events happen in a deterministic way but they can be computed as probabilities like the infections or deaths.

if(length(which(df>=3+silent_infection))>0) df[which(df>=3+silent_infection)]<-2
  
Finally, we save the status of the population as a row in a large matrix(progression[i,]<-df), so we can explore it after the simulation is completed. 

And that's it!! We are done.

We can make this process more complex by adding more constrains of more vectors to represent for instance other countries/cities with other densities/inmune people but the core of the simulation is done, we only need to start playing around and ploting the results.

##Plots and inferences

##Conclusions
